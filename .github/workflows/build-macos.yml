# SPDX-FileCopyrightText: 2015-2025 Alexey Rochev
#
# SPDX-License-Identifier: CC0-1.0

name: Build Tremotesf for MacOS

on:
  workflow_call:
    inputs:
      release-tag:
        description: Release tag
        type: string
        required: false
        default: ''

jobs:
  build-macos:
    strategy:
      fail-fast: false
      matrix:
        architecture: ['arm64', 'x86_64']

    runs-on: macos-latest
    steps:
      - name: Add GCC problem matcher
        uses: ammaraskar/gcc-problem-matcher@0f9c86f9e693db67dacf53986e1674de5f2e5f28

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          submodules: 'recursive'

      - name: Use latest Xcode
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd
        with:
          # xcode-version: latest-stable
          # https://bugreports.qt.io/browse/QTBUG-137687
          # Switch back to latest-stable after Qt in vcpkg is updated to 6.9.2 or newer
          xcode-version: 16.4

      - name: Set up vcpkg
        uses: equeim/action-setup-vcpkg@ee4e4882f5d857900b56e5a6b000930d99cca824
        with:
          vcpkg-root: ${{ github.workspace }}/vcpkg
          save-cache: ${{ github.event_name != 'pull_request' }}
          cache-key-tag: ${{ matrix.architecture }}

      - name: Install host dependencies
        run: |
          brew install autoconf automake libtool ninja

      - name: Build Tremotesf for ${{ matrix.architecture }} architecture
        id: build
        uses: equeim/action-cmake-build@ad8fb686c1e3e022cc3044377a966a027f5678e4
        with:
          cmake-arguments: --preset macos-${{ matrix.architecture }}-vcpkg -D TREMOTESF_ASAN=${{ inputs.release-tag == '' && 'ON' || 'OFF' }}
          package: true
        env:
          ASAN_OPTIONS: detect_leaks=0

      - name: Archive packages
        if: inputs.release-tag == ''
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: macos-${{ matrix.architecture }}-packages
          retention-days: ${{ github.event_name == 'push' && 7 || 3 }}
          path: |
            ${{ steps.build.outputs.build-directory }}/packaging/macos/*.dmg

      - name: Upload packages to release
        if: inputs.release-tag != ''
        run: |
          packages=(${{ steps.build.outputs.build-directory }}/packaging/macos/*.dmg)
          echo "Uploading packages ${packages[@]}"
          gh release upload '${{ inputs.release-tag }}' "${packages[@]}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Archive build logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        if: always()
        with:
          name: macos-${{ matrix.architecture }}-build-logs
          retention-days: ${{ github.event_name == 'push' && 7 || 3 }}
          path: |
            ${{ steps.build.outputs.build-directory }}/CMakeCache.txt
            ${{ steps.build.outputs.build-directory }}/compile_commands.json
            ${{ steps.build.outputs.build-directory }}/vcpkg-manifest-install.log
            ${{ steps.build.outputs.build-directory }}/CMakeFiles/CMakeConfigureLog.yaml
            ${{ env.VCPKG_ROOT }}/buildtrees/*/*.log
